name: 微信热搜榜定时推送

on:
  schedule:
    # 每天北京时间上午10:00执行 (UTC时间2:00)
    - cron: '0 2 * * *'
    # 每天北京时间下午6:00执行 (UTC时间10:00) - 可选的第二次推送
    # - cron: '0 10 * * *'
  workflow_dispatch: # 允许手动触发
    inputs:
      test_mode:
        description: '是否为测试模式'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  push-hotlist:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置Node.js环境
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: 安装依赖
      run: npm ci
      
    - name: 执行热搜推送
      run: |
        if [ "${{ github.event.inputs.test_mode }}" = "true" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "🧪 执行测试模式推送"
          node index.js --test
        else
          echo "🚀 执行正式推送"
          node index.js
        fi
      env:
        WXPUSHER_APP_TOKEN: ${{ secrets.WXPUSHER_APP_TOKEN }}
        WXPUSHER_UID: ${{ secrets.WXPUSHER_UID }}
        TIANAPI_KEY: ${{ secrets.TIANAPI_KEY }}
        TIANAPI_URL: https://apis.tianapi.com/wxhottopic/index
        PUSH_HOUR: 9
        PUSH_MINUTE: 0
        HOT_LIST_COUNT: 30
        TZ: Asia/Shanghai
        
    - name: 推送结果通知
      if: always()
      run: |
        current_time=$(date '+%Y-%m-%d %H:%M:%S')
        if [ $? -eq 0 ]; then
          echo "✅ [$current_time] 热搜推送任务执行成功"
        else
          echo "❌ [$current_time] 热搜推送任务执行失败"
          exit 1
        fi
        
    - name: 上传日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: push-logs-${{ github.run_number }}
        path: logs/
        retention-days: 7
